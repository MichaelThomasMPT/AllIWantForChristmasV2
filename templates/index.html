<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>All I Want For Christmas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='style.css') }}"
  >
</head>
<body class="page-main">
  <div class="app">
    <div class="card">
      <h1>All I Want For Christmas</h1>

      <button id="logButton" class="big-button">
        <span>I HEAR MARIAH</span>
      </button>

      <div class="secondary-row">
        <button id="viewLogButton" class="secondary-button" type="button">
          üìú View Log
        </button>
        <button id="retryLocationButton" class="secondary-button" type="button">
          üìç Retry Location
        </button>
      </div>

      <div id="status" class="status"></div>
    </div>
  </div>

  <script>
    let lastPosition = null;

    function setStatus(message, type) {
      const el = document.getElementById("status");
      el.textContent = message || "";
      el.classList.remove("ok", "error");
      if (type) el.classList.add(type);
    }

    function fetchLocation() {
      if (!navigator.geolocation) {
        setStatus("Geolocation not supported on this device.", "error");
        return;
      }

      setStatus("Getting your location‚Ä¶", null);

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          lastPosition = {
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
          };
          setStatus("Location ready ‚úîÔ∏è", "ok");
        },
        (err) => {
          console.warn("Geolocation error", err);
          lastPosition = null;
          if (err.code === err.PERMISSION_DENIED) {
            setStatus("Location permission denied. We'll still log the time.", "error");
          } else {
            setStatus("Couldn't get location. We'll still log the time.", "error");
          }
        },
        {
          enableHighAccuracy: true,
          timeout: 8000,
          maximumAge: 60000,
        }
      );
    }

    async function sendLog() {
      const button = document.getElementById("logButton");
      button.disabled = true;
      button.classList.add("big-button-disabled");

      const clientTs = new Date().toISOString();

      const payload = {
        client_timestamp: clientTs,
        latitude: lastPosition ? lastPosition.latitude : null,
        longitude: lastPosition ? lastPosition.longitude : null,
        accuracy: lastPosition ? lastPosition.accuracy : null,
      };

      try {
        const resp = await fetch("/log", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });

        if (!resp.ok) {
          throw new Error("Server returned " + resp.status);
        }
        const data = await resp.json();
        if (data.success) {
          setStatus("Logged! Mariah has been noted. üéß", "ok");
        } else {
          setStatus("Log failed: " + (data.error || "Unknown error."), "error");
        }
      } catch (e) {
        console.error(e);
        setStatus("Couldn't send to server. Are you on the same network?", "error");
      } finally {
        button.disabled = false;
        button.classList.remove("big-button-disabled");
      }
    }

    document.getElementById("logButton").addEventListener("click", () => {
      sendLog();
    });

    document.getElementById("viewLogButton").addEventListener("click", () => {
      window.location.href = "/logs";
    });

    document.getElementById("retryLocationButton").addEventListener("click", () => {
      fetchLocation();
    });

    // Grab location early so it's hopefully ready when you tap
    window.addEventListener("load", () => {
      fetchLocation();
    });
  </script>
</body>
</html>
